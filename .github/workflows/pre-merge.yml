---
# SPDX-FileCopyrightText: (C) 2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

name: Pre-Merge CI Pipeline

on:
  pull_request:
    branches:
      - main
      - release-*
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  pre-merge-pipeline:
    permissions:
      contents: read
    runs-on: ubuntu-24.04-4core-16GB
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd    # v6.0.2
        with:
          fetch-depth: 0   # Fetch all history, WO sporadic issue with missing tags
          fetch-tags: true    # Fetch tags
          ref: ${{ github.head_ref }}    # Checkout the branch that triggered the workflow to avoid detached HEAD
          persist-credentials: false

      - name: Checkout action repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd    # v6.0.2
        with:
          repository: open-edge-platform/orch-ci
          path: ci
          persist-credentials: false

      # TODO: maybe we can simplify and avoid the heavy lifting of the bootstrap action
      - name: Set enviroment
        uses: open-edge-platform/orch-ci/.github/actions/bootstrap@cd0b18b2ef0e2c52665525fa5503b8ec5edd232f  # v2026.0.10
        with:
          gh_token: ${{ secrets.SYS_EMF_GH_TOKEN }}

      - name: Printenv
        run: printenv

      # TODO: check that env variable used are correct
      - name: Helm Check Version Change
        env:
          BASE_REF: ${{ github.base_ref }}
        run: |
          echo "Checks that changes to a chart include a change to the chart version"
          APPVERSION_IS_VERSION=0 COMPARISON_BRANCH=origin/${BASE_REF} ./ci/scripts/helm-version-check.sh

      - name: Run linters
        run: make lint

      - name: Build and pack charts
        run: make helm-build

      - name: Verify if release
        run: |
          SEMVER_PATTERN="^[0-9]+\.[0-9]+\.[0-9]+$"
          INFRA_CORE_RELEASE=`(yq '.version' infra-core/Chart.yaml | grep -Eq ${SEMVER_PATTERN}) && echo 1 || echo 0`
          INFRA_MANAGERS_RELEASE=`(yq '.version' infra-managers/Chart.yaml | grep -Eq ${SEMVER_PATTERN}) && echo 1 || echo 0`
          INFRA_EXTERNAL_RELEASE=`(yq '.version' infra-external/Chart.yaml | grep -Eq ${SEMVER_PATTERN}) && echo 1 || echo 0`
          INFRA_ONBOARDING_RELEASE=`(yq '.version' infra-onboarding/Chart.yaml | grep -q "\-dev") && echo 0 || echo 1`
          echo "INFRA_CORE_RELEASE=${INFRA_CORE_RELEASE}" >> $GITHUB_ENV
          echo "INFRA_MANAGERS_RELEASE=${INFRA_MANAGERS_RELEASE}" >> $GITHUB_ENV
          echo "INFRA_EXTERNAL_RELEASE=${INFRA_EXTERNAL_RELEASE}" >> $GITHUB_ENV
          echo "INFRA_ONBOARDING_RELEASE=${INFRA_ONBOARDING_RELEASE}" >> $GITHUB_ENV

      - name: Create kind cluster
        run: |
          kind create cluster -n orch-infra-test --image "kindest/node:v1.26.4"
          kubectl create ns orch-infra

      - name: Printenv
        run: printenv

      - name: Deploy Umbrella Charts
        run: |
          set -x
          # Generate a random password for CI testing
          ORCH_DEFAULT_PASSWORD=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-25)
          PUBLIC_RS="registry-rs.edgeorchestration.intel.com/edge-orch/"
          DEV_VALUES="-f tools/latest-dev-components.yaml"
          CORE_DEV_VALUES=""
          MANAGERS_DEV_VALUES=""
          EXTERNAL_DEV_VALUES=""
          ONBOARDING_DEV_VALUES=""
          if [ "${INFRA_CORE_RELEASE}" -eq 0 ]; then
            echo "Infra Core dev version"
            CORE_DEV_VALUES=${DEV_VALUES}
          else
            echo "Infra Core release"
          fi
          if [[ "${INFRA_MANAGERS_RELEASE}" -eq 0 ]]; then
            echo "Infra Managers dev version"
            MANAGERS_DEV_VALUES=${DEV_VALUES}
          else
            echo "Infra Managers release"
          fi
          if [ "${INFRA_EXTERNAL_RELEASE}" -eq 0 ]; then
            echo "Infra External dev version"
            EXTERNAL_DEV_VALUES=${DEV_VALUES}
          else
            echo "Infra External release"
          fi
          if [ "${INFRA_ONBOARDING_RELEASE}" -eq 0 ]; then
            echo "Infra Onboarding dev version"
            ONBOARDING_DEV_VALUES=${DEV_VALUES}
          else
            echo "Infra Onboarding release"
          fi

          helm install -n orch-infra --set global.registry.name="${PUBLIC_RS}" \
            --set import.credentials.enabled=false \
            --set import.tenant-controller.enabled=false \
            --set tenant-controller.managerArgs.disableCredentialsManagement=true \
            --set inventory.postgresql.pod.enabled=true \
            --set inventory.postgresql.auth.password="${ORCH_DEFAULT_PASSWORD}" ${CORE_DEV_VALUES} \
            infra-core ./infra-core

          helm install -n orch-infra --set global.registry.name="${PUBLIC_RS}" \
            --set loca-manager.serviceArgs.disableCredentialsManagement=true \
            --set loca-metadata-manager.serviceArgs.disableCredentialsManagement=true \
            --set import.loca-credentials.enabled=false ${EXTERNAL_DEV_VALUES} \
            --set import.amt.enabled=false \
            infra-external ./infra-external

          helm install -n orch-infra --set global.registry.name="${PUBLIC_RS}" \
            --set inventory.postgresql.auth.password="${ORCH_DEFAULT_PASSWORD}" ${MANAGERS_DEV_VALUES} \
            infra-managers ./infra-managers

          # TODO: find a way to at least deploy OM, it currently depends on the RS.
          helm install -n orch-infra --set global.registry.name="${PUBLIC_RS}" \
            --set onboarding-manager.managerArgs.disableCredentialsManagement=true \
            --set import.dkam.enabled=false \
            --set import.onboarding-manager.enabled=false \
            --set tinkerbell.pvc.enabled=true \
            --set tinkerbell.pvc.storageSize=128Mi ${ONBOARDING_DEV_VALUES} \
            infra-onboarding ./infra-onboarding

      - name: Verify Kind deployment
        shell: bash
        run: |
          set -x
          echo "==== Waiting for node readiness ===="
          kubectl wait --for=condition=Ready nodes --all --timeout=5m

          echo "==== Storage Classes ===="
          kubectl get storageclass || true

          echo "==== PVC Status ===="
          kubectl get pvc -n orch-infra || true

          echo "==== Current cluster state ===="
          kubectl get pods -n orch-infra
          kubectl get pv -A || true

          echo "==== Waiting for PVCs to bind (if provisioner exists) ===="
          kubectl wait --for=condition=Bound pvc --all -n orch-infra --timeout=5m || true
          echo "==== Initial Pod Status ===="
          kubectl get pods -n orch-infra -o wide

          echo "==== Pod Events Before Rollout ===="
          kubectl get events -n orch-infra --sort-by='.lastTimestamp' || true

          echo "==== Node Resources ===="
          kubectl top nodes || true
          kubectl describe nodes || true

          echo "==== Namespace Resources ===="
          kubectl get all -n orch-infra

          # Function to get detailed pod info on failure
          debug_pod_failure() {
            local resource=$1
            local resource_name=$(echo "$resource" | cut -d'/' -f2)
            
            echo "==== FAILURE: Debugging $resource ===="
            kubectl describe "$resource" -n orch-infra || true
            
            echo "==== Events for $resource ===="
            kubectl get events -n orch-infra --field-selector involvedObject.name="$resource_name" --sort-by='.lastTimestamp' || true
            
            echo "==== Pods for $resource ===="
            kubectl get pods -n orch-infra -l "app.kubernetes.io/instance=${resource_name}" -o wide || true
            
            echo "==== Pod Logs for $resource ===="
            for pod in $(kubectl get pods -n orch-infra -l "app.kubernetes.io/instance=${resource_name}" -o name 2>/dev/null); do
              echo "---- Logs from $pod ----"
              kubectl logs "$pod" -n orch-infra --tail=100 --all-containers=true || true
              echo "---- Previous logs from $pod ----"
              kubectl logs "$pod" -n orch-infra --tail=100 --previous --all-containers=true 2>/dev/null || true
            done
            
            echo "==== ReplicaSet Status for $resource ===="
            kubectl get rs -n orch-infra -l "app.kubernetes.io/instance=${resource_name}" -o wide || true
          }

          echo "==== Waiting for Deployments rollout ===="
          DEPLOYMENT_TIMEOUT=20m
          DEPLOYMENT_FAILURES=0

          for d in $(kubectl get deployment -n orch-infra -o name); do
            echo "---- Rolling out $d ----"
            kubectl get "$d" -n orch-infra -o wide
            
            if ! kubectl rollout status "$d" -n orch-infra --timeout="${DEPLOYMENT_TIMEOUT}"; then
              echo "ERROR: Deployment $d failed to rollout"
              debug_pod_failure "$d"
              DEPLOYMENT_FAILURES=$((DEPLOYMENT_FAILURES + 1))
            else
              echo "SUCCESS: $d rolled out successfully"
            fi
          done

          echo "==== Intermediate Pod Status ===="
          kubectl get pods -n orch-infra -o wide

          echo "==== Waiting for StatefulSets rollout ===="
          STATEFULSET_TIMEOUT=15m
          STATEFULSET_FAILURES=0
          
          for s in $(kubectl get statefulset -n orch-infra -o name); do
            echo "---- Rolling out $s ----"
            kubectl get "$s" -n orch-infra -o wide
            
            if ! kubectl rollout status "$s" -n orch-infra --timeout="${STATEFULSET_TIMEOUT}"; then
              echo "ERROR: StatefulSet $s failed to rollout"
              debug_pod_failure "$s"
              STATEFULSET_FAILURES=$((STATEFULSET_FAILURES + 1))
            else
              echo "SUCCESS: $s rolled out successfully"
            fi
          done

          echo "==== Final Pod Status ===="
          kubectl get pods -n orch-infra -o wide
          
          echo "==== Final Events ===="
          kubectl get events -n orch-infra --sort-by='.lastTimestamp' | tail -50 || true
          
          echo "==== Resource Usage ===="
          kubectl top pods -n orch-infra || true

          # Check for failures
          TOTAL_FAILURES=$((DEPLOYMENT_FAILURES + STATEFULSET_FAILURES))
          if [ "$TOTAL_FAILURES" -gt 0 ]; then
            echo "ERROR: $DEPLOYMENT_FAILURES deployment(s) and $STATEFULSET_FAILURES statefulset(s) failed to rollout"
            exit 1
          fi
          
          echo "All services up and running"

  final-check:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    if: ${{ always() }}
    needs: [pre-merge-pipeline]
    env:
      result: ${{ needs.pre-merge-pipeline.result }}
    steps:
      - name: Final Status Check
        run: |
          pre_merge_pipeline="${result}"

          results=("pre_merge_pipeline")
          status="OK"

          for result in "${results[@]}"; do
            pipeline_result=$(eval echo \$$result)
            echo "${result} result: $pipeline_result"
            if [[ "$pipeline_result" != "success" && "$pipeline_result" != "skipped" ]]; then
              status="KO"
            fi
          done

          if [[ "$status" == "OK" ]]; then
            echo "Pre-merge check passed successfully."
          else
            echo "All pre-merge checks failed or were skipped. PR can't get merged"
            exit 1
          fi
