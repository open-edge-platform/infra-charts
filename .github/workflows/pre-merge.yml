---
# SPDX-FileCopyrightText: (C) 2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

name: Pre-Merge CI Pipeline

on:
  pull_request:
    branches:
      - main
      - release-*
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  pre-merge-pipeline:
    permissions:
      contents: read
    runs-on: ubuntu-24.04-4core-16GB
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd    # v6.0.2
        with:
          fetch-depth: 0   # Fetch all history, WO sporadic issue with missing tags
          fetch-tags: true    # Fetch tags
          ref: ${{ github.head_ref }}    # Checkout the branch that triggered the workflow to avoid detached HEAD
          persist-credentials: false

      - name: Checkout action repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd    # v6.0.2
        with:
          repository: open-edge-platform/orch-ci
          path: ci
          persist-credentials: false

      # TODO: maybe we can simplify and avoid the heavy lifting of the bootstrap action
      - name: Set enviroment
        uses: open-edge-platform/orch-ci/.github/actions/bootstrap@467367d6f859a4654f2645ca78efd60035cf390c  # v2026.0.8
        with:
          gh_token: ${{ secrets.SYS_EMF_GH_TOKEN }}

      - name: Printenv
        run: printenv

      # TODO: check that env variable used are correct
      - name: Helm Check Version Change
        env:
          BASE_REF: ${{ github.base_ref }}
        run: |
          echo "Checks that changes to a chart include a change to the chart version"
          APPVERSION_IS_VERSION=0 COMPARISON_BRANCH=origin/${BASE_REF} ./ci/scripts/helm-version-check.sh

      - name: Run linters
        run: make lint

      - name: Build and pack charts
        run: make helm-build

      - name: Verify if release
        run: |
          SEMVER_PATTERN="^[0-9]+\.[0-9]+\.[0-9]+$"
          INFRA_CORE_RELEASE=`(yq '.version' infra-core/Chart.yaml | grep -Eq ${SEMVER_PATTERN}) && echo 1 || echo 0`
          INFRA_MANAGERS_RELEASE=`(yq '.version' infra-managers/Chart.yaml | grep -Eq ${SEMVER_PATTERN}) && echo 1 || echo 0`
          INFRA_EXTERNAL_RELEASE=`(yq '.version' infra-external/Chart.yaml | grep -Eq ${SEMVER_PATTERN}) && echo 1 || echo 0`
          INFRA_ONBOARDING_RELEASE=`(yq '.version' infra-onboarding/Chart.yaml | grep -q "\-dev") && echo 0 || echo 1`
          echo "INFRA_CORE_RELEASE=${INFRA_CORE_RELEASE}" >> $GITHUB_ENV
          echo "INFRA_MANAGERS_RELEASE=${INFRA_MANAGERS_RELEASE}" >> $GITHUB_ENV
          echo "INFRA_EXTERNAL_RELEASE=${INFRA_EXTERNAL_RELEASE}" >> $GITHUB_ENV
          echo "INFRA_ONBOARDING_RELEASE=${INFRA_ONBOARDING_RELEASE}" >> $GITHUB_ENV

      - name: Create kind cluster
        run: |
          set -euo pipefail

          # 1. Create cluster
          kind create cluster --name orch-infra-test --image kindest/node:v1.26.4

          # 2. Create orch namespace
          kubectl create ns orch-infra || true

          # 3. The local-path StorageClass is already created by kind,
          #    no need to patch or delete it. Just ensure the provisioner namespace exists
          kubectl create ns local-path-storage || true

          # 4. Apply the default local-path provisioner manifest (safe: will not overwrite immutable fields)
          kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/master/deploy/local-path-storage.yaml

          # 5. Wait for provisioner pod to be ready
          kubectl rollout status deployment/local-path-provisioner -n local-path-storage --timeout=2m

          # 6. Verify StorageClass
          kubectl get storageclass

      - name: Printenv
        run: printenv

      - name: Deploy Umbrella Charts
        run: |
          set -x
          # Generate a random password for CI testing
          ORCH_DEFAULT_PASSWORD=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-25)
          PUBLIC_RS="registry-rs.edgeorchestration.intel.com/edge-orch/"
          DEV_VALUES="-f tools/latest-dev-components.yaml"
          CORE_DEV_VALUES=""
          MANAGERS_DEV_VALUES=""
          EXTERNAL_DEV_VALUES=""
          ONBOARDING_DEV_VALUES=""

          if [ "${INFRA_CORE_RELEASE}" -eq 0 ]; then
            echo "Infra Core dev version"
            CORE_DEV_VALUES=${DEV_VALUES}
          else
            echo "Infra Core release"
          fi
          if [[ "${INFRA_MANAGERS_RELEASE}" -eq 0 ]]; then
            echo "Infra Managers dev version"
            MANAGERS_DEV_VALUES=${DEV_VALUES}
          else
            echo "Infra Managers release"
          fi
          if [ "${INFRA_EXTERNAL_RELEASE}" -eq 0 ]; then
            echo "Infra External dev version"
            EXTERNAL_DEV_VALUES=${DEV_VALUES}
          else
            echo "Infra External release"
          fi
          if [ "${INFRA_ONBOARDING_RELEASE}" -eq 0 ]; then
            echo "Infra Onboarding dev version"
            ONBOARDING_DEV_VALUES=${DEV_VALUES}
          else
            echo "Infra Onboarding release"
          fi

          # --- Helm installs with storage class overrides for CI ---
          helm install -n orch-infra --wait --timeout 15m --set global.registry.name="${PUBLIC_RS}" \
            --set import.credentials.enabled=false \
            --set import.tenant-controller.enabled=false \
            --set tenant-controller.managerArgs.disableCredentialsManagement=true \
            --set inventory.postgresql.pod.enabled=true \
            --set inventory.postgresql.auth.password="${ORCH_DEFAULT_PASSWORD}" \
            --set inventory.postgresql.persistence.storageClass=local-path \
            --set global.imagePullSecrets=[] \
            ${CORE_DEV_VALUES} \
            infra-core ./infra-core

          helm install -n orch-infra --wait --timeout 15m --set global.registry.name="${PUBLIC_RS}" \
            --set loca-manager.serviceArgs.disableCredentialsManagement=true \
            --set loca-metadata-manager.serviceArgs.disableCredentialsManagement=true \
            --set import.loca-credentials.enabled=false \
            --set import.amt.enabled=false \
            --set global.imagePullSecrets=[] \
            ${EXTERNAL_DEV_VALUES} \
            infra-external ./infra-external

          helm install -n orch-infra --wait --timeout 15m --set global.registry.name="${PUBLIC_RS}" \
            --set inventory.postgresql.auth.password="${ORCH_DEFAULT_PASSWORD}" \
            --set inventory.postgresql.persistence.storageClass=local-path \
            --set global.imagePullSecrets=[] \
            ${MANAGERS_DEV_VALUES} \
            infra-managers ./infra-managers

          helm install -n orch-infra --wait --timeout 15m --set global.registry.name="${PUBLIC_RS}" \
            --set onboarding-manager.managerArgs.disableCredentialsManagement=true \
            --set import.dkam.enabled=false \
            --set import.onboarding-manager.enabled=false \
            --set tinkerbell.pvc.enabled=true \
            --set tinkerbell.pvc.storageSize=128Mi \
            --set tinkerbell.pvc.storageClassName=local-path \
            --set global.imagePullSecrets=[] \
            ${ONBOARDING_DEV_VALUES} \
            infra-onboarding ./infra-onboarding

      - name: Verify Kind deployment
        shell: bash
        run: |
          set -euo pipefail

          echo "==== System Info ===="
          cat /proc/cpuinfo
          cat /proc/meminfo

          echo "==== Waiting for node readiness ===="
          kubectl wait --for=condition=Ready nodes --all --timeout=5m

          echo "==== Storage Classes ===="
          kubectl get storageclass || true

          echo "==== Current cluster state ===="
          kubectl get pods -n orch-infra
          kubectl get pv -A || true

          echo "==== Waiting for any PVC to appear ===="
          for i in {1..12}; do
            pvc_count=$(kubectl get pvc -n orch-infra --no-headers 2>/dev/null | wc -l)
            if [ "$pvc_count" -gt 0 ]; then
              echo "Found $pvc_count PVC(s)"
              break
            fi
            echo "No PVCs yet, retrying... ($i/12)"
            sleep 5
          done

          echo "==== Waiting for all PVCs to bind ===="
          for pvc in $(kubectl get pvc -n orch-infra -o name); do
            echo "Waiting for $pvc to be Bound..."
            kubectl wait --for=condition=Bound $pvc -n orch-infra --timeout=15m
          done

          echo "==== Waiting for Deployments rollout ===="
          for d in $(kubectl get deployment -n orch-infra -o name); do
            kubectl rollout status "$d" -n orch-infra --timeout=15m
          done

          echo "==== Waiting for StatefulSets rollout ===="
          for s in $(kubectl get statefulset -n orch-infra -o name); do
            kubectl rollout status "$s" -n orch-infra --timeout=10m
          done

          echo "==== Final Pod Status ===="
          kubectl get pods -n orch-infra -o wide
          echo "All services up and running"

  final-check:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    if: ${{ always() }}
    needs: [pre-merge-pipeline]
    env:
      result: ${{ needs.pre-merge-pipeline.result }}
    steps:
      - name: Final Status Check
        run: |
          pre_merge_pipeline="${result}"

          results=("pre_merge_pipeline")
          status="OK"

          for result in "${results[@]}"; do
            pipeline_result=$(eval echo \$$result)
            echo "${result} result: $pipeline_result"
            if [[ "$pipeline_result" != "success" && "$pipeline_result" != "skipped" ]]; then
              status="KO"
            fi
          done

          if [[ "$status" == "OK" ]]; then
            echo "Pre-merge check passed successfully."
          else
            echo "All pre-merge checks failed or were skipped. PR can't get merged"
            exit 1
          fi
