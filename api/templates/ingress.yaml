# SPDX-FileCopyrightText: (C) 2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0
---
{{- if .Values.traefikReverseProxy.enabled }}
apiVersion: {{ .Values.traefikApiGroup }}
kind: IngressRoute
metadata:
  name: "api-http"
  namespace: {{ .Values.traefikReverseProxy.gatewayNamespace }}
spec:
  entryPoints: # We listen to requests coming from ports 443
    - websecure
  routes:
    - match: "Host(`{{ .Values.traefikReverseProxy.host.grpc.name }}`) && PathPrefix(`/`)"
      kind: Rule
      services:
        - name: {{ include "api.fullname" . }}
          port: {{ .Values.service.port }}
          scheme: http
          namespace: {{ .Release.Namespace }}
      middlewares:
        - name: validate-jwt
        - name: svc-edge-infra-api-orch-infra
  tls:
    # Use the secret generated by cert-manager that resides in orch-gateway namespace
    secretName: {{ .Values.traefikReverseProxy.secretName }}
{{- if .Values.traefikReverseProxy.tlsOption }}
    options:
      name: {{ .Values.traefikReverseProxy.tlsOption }}
      namespace: {{ .Values.traefikReverseProxy.gatewayNamespace }}
{{- end }}
---
apiVersion: {{ .Values.traefikApiGroup }}
kind: Middleware
metadata:
  name: svc-edge-infra-api-orch-infra
  namespace: {{ .Values.traefikReverseProxy.gatewayNamespace }}
spec:
  headers:
    customRequestHeaders:
      Host: {{ include "api.fullname" . }}.{{ .Release.Namespace }}.svc
{{- end }}
